import { useState, useEffect, useCallback } from 'react';
import { QuizCard, SkeletonQuizCard, NotFound } from 'components/common';
import styled from 'styled-components';
import { RecentQuizListApi } from 'pages/api/quiz';
import { MdKeyboardArrowDown } from 'react-icons/md';

const RecentQuizList = () => {
  const [recentQuizList, setRecentQuizList] = useState<QuizCardType[] | null>(null);
  const [end, setEnd] = useState(false); //Î™®Îì† Í∏Ä Î°úÎìú ÌôïÏù∏
  const [load, setLoad] = useState(false); //Î°úÎî©
  const [page, setPage] = useState<number>(0); // ÎÇ¥Î∂Ä ÏÇ¨Ïö©Ïö© page Ïπ¥Ïö¥Ìä∏

  const getRecentQuizList = useCallback(
    async (lastCreatedAt?: string) => {
      setLoad(true);
      const res = await RecentQuizListApi(lastCreatedAt);
      if (res?.data?.length === 0) {
        if (recentQuizList === null) {
          setRecentQuizList([]);
        }
        setEnd(true);
        // ÏùëÎãµ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÎã§Î©¥. Ï¶â, ÎßàÏßÄÎßâ ÌéòÏù¥ÏßÄ ÎùºÎ©¥?
      } else {
        const _quizList = res.data;
        setRecentQuizList(recentQuizList ? [...recentQuizList, ..._quizList] : _quizList);
      }
      setLoad(false); //Î°úÎî© Ï¢ÖÎ£å
    },
    [page],
  );

  useEffect(() => {
    getRecentQuizList();
  }, []);

  useEffect(() => {
    if (recentQuizList && recentQuizList.length !== 0) {
      const { created_at } = recentQuizList?.slice(-1)[0];
      let _creaetedAt = created_at.replace('T', ' ');
      _creaetedAt = _creaetedAt.replace('Z', '');
      getRecentQuizList(_creaetedAt); // Î¨∏Ï†ú Î™©Î°ù Î∂àÎü¨Ïò§Í∏∞
    }
  }, [page]);

  return (
    <Wrapper>
      <ListWrapper>
        {recentQuizList ? (
          recentQuizList.length === 0 ? (
            <PaddingBottom>
              <NotFound title={'Îì±Î°ùÎêú ÌÄ¥Ï¶à ÏÑ∏Ìä∏Í∞Ä ÏóÜÏäµÎãàÎã§ üò£'} subTitle={'ÌÄ¥Ï¶à ÏÑ∏Ìä∏Î•º ÎßåÎì§Ïñ¥Ï£ºÏÑ∏Ïöî !! '} />
            </PaddingBottom>
          ) : (
            <>
              {recentQuizList.map((quiz) => {
                return (
                  <>
                    <QuizCard key={quiz.id} recentQuiz={quiz}  />
                  </>
                );
              })}
              {load && (
                <PaddingBottom>
                  <SkeletonQuizCard isthumb={false} />
                  <SkeletonQuizCard isthumb={false} />
                  <SkeletonQuizCard isthumb={false} />
                </PaddingBottom>
              )}
              {!end && (
                <QuizLoad
                  onClick={() => {
                    setPage((prev) => prev + 1);
                  }}
                >
                  <MdKeyboardArrowDown size={20} />
                  ÎçîÎ≥¥Í∏∞
                </QuizLoad>
              )}
            </>
          )
        ) : (
          <PaddingBottom>
            <SkeletonQuizCard isthumb={false} />
            <SkeletonQuizCard isthumb={false} />
            <SkeletonQuizCard isthumb={false} />
          </PaddingBottom>
        )}
      </ListWrapper>
    </Wrapper>
  );
};

const Wrapper = styled.div`
  width: 100%;
  margin: 0 auto;
`;

const QuizLoad = styled.button`
  border: none;
  display: flex;
  align-items: center;
  background-color: transparent;
  font-size: 14px;
  font-weight: bold;
  color: #595959;
  padding-bottom: 40px;
  padding-top: 1rem;
  &:hover {
    cursor: pointer;
  }
`;
const ListWrapper = styled.div`
  display: flex;
  align-items: center;
  flex-direction: column;
  margin-top: 1.5rem;
`;

const PaddingBottom = styled.div`
  padding-bottom: 80px;
  width:100%;
`;
export default RecentQuizList;
