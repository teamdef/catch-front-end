name: Build and Deploy
on:
  push:
    branches:
      - develop

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2.3.1
        with:
          persist-credentials: false

      - name: Install and Build
        uses: actions/setup-node@v1
      - run: rm -rf node_modules/.cache # node_modules ìºì‹œ ì œê±°
      - run: yarn install # í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
      - run: next build # next.js í”„ë¡œì íŠ¸ ë¹Œë“œ
      - run: next export # next.js í”„ë¡œì íŠ¸ë¥¼ static htmlì•±ìœ¼ë¡œ ì»´íŒŒì¼ í•œ out/ í´ë”ë¥¼ ìƒì„±í•´ ì¤Œ
      - run: touch out/.nojekyll # github pageì˜ jekyll ì²˜ë¦¬ê³¼ì • ì—ì„œ .nextì™€ ê°™ì€ íŒŒì¼ì„ íŠ¹ìˆ˜ ë¦¬ì†ŒìŠ¤ë¡œ ê°„ì£¼í•˜ê³  ìµœì¢… ì‚¬ì´íŠ¸ì— ë³µì‚¬í•˜ì§€ ì•ŠëŠ” ê²ƒì„ ë°©ì§€
      - run: git add -f out/ # out/ ë””ë ‰í† ë¦¬ëŠ” .gitignoreì— ë“±ë¡ë˜ì–´ ìˆìœ¼ë¯€ë¡œ -f ì˜µì…˜ì„ ì´ìš©í•´ ë¬´ì‹œí•˜ë„ë¡ í•¨
      - run: git checkout -b temp-for-deploy-gh-pages # temp-for-deploy-gh-pages ë¸Œëœì¹˜ë¥¼ ìƒì„±í•œë‹¤.
      - run: git commit -m "Deploy Next.js to gh-pages" # ìƒì„±í•œ ë¸ŒëŸ°ì¹˜ì— out/ ë””ë ‰í† ë¦¬ê°€ í¬í•¨ëœ ë‚´ìš©ì„ ì»¤ë°‹í•œë‹¤
      - run: git subtree split --prefix out -b gh-pages # í•´ë‹¹ ì»¤ë°‹ì„ ì‚¬ìš©í•´ /out ë””ë ‰í† ë¦¬ ë§Œìœ¼ë¡œ ë¡œì»¬ì˜ gh-pages ë¸Œëœì¹˜ì— ìƒˆë¡œìš´ ì»¤ë°‹ì„ ë§Œë“ ë‹¤. github ì €ì¥ì†Œ gh-pagesë¸Œëœì¹˜ì— push
      - run: git push -f origin gh-pages:gh-pages # ë¡œì»¬ì˜ gh-pagesë¥¼ ê°•ì œë¡œ gh-pages ì— í‘¸ì‹œí•œë‹¤.
      - run: git branch -D gh-pages # ë¡œì»¬ì˜ gh-pages ë¸ŒëŸ°ì¹˜ë¥¼ ì‚­ì œí•œë‹¤
      # temp-for-deploy-gh-pages ë¸Œëœì¹˜ë¥¼ ì‚­ì œí•œë‹¤.
      - run: git checkout develop
      - run: git branch -D temp-for-deploy-gh-pages
      # gh-pagesë¥¼ ê°•ì œë¡œ í‘¸ì‹œí•˜ëŠ” ì´ìœ ëŠ” ì´ë¯¸ ì›ê²©ì— gh-pages ë¸Œëœì¹˜ê°€ ìˆì„ ê²½ìš°, ìƒˆë¡œìš´ ì»¤ë°‹ì´ ì›ê²©ì— ìˆëŠ” ê¸°ì¡´ì˜ ì»¤ë°‹ê³¼ ì´ì–´ì§€ì§€ ì•ŠëŠ” ì»¤ë°‹ì´ê¸° ë•Œë¬¸ì´ë‹¤.
        env:
          CI: true
          DEPLOY_TARGET: gh-pages
      

      - name: Deploy ğŸš€
        uses: JamesIves/github-pages-deploy-action@3.7.1 # github action marketplace ì—ì„œ ì‚¬ìš©í•  í…œí”Œë¦¿ì„ ê°€ì ¸ì˜´ 
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: gh-pages  # ë°°í¬ë  ë¸Œëœì¹˜
          FOLDER: out # ì´ í´ë”ì— ìˆëŠ” íŒŒì¼ì„ ë°°í¬
          CLEAN: true # ë°°í¬ ë¸Œëœì¹˜ì— ìˆëŠ” íŒŒì¼ë“¤ì„ ìë™ìœ¼ë¡œ ì‚­ì œ